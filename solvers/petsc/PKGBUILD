# Maintainer: Myles English <myles at rockhead dot biz>
pkgname=petsc
pkgver=3.1_p5
_config=linux-gnu-cxx-debug
pkgrel=1
pkgdesc="Portable, extensible toolkit for scientific computation"
arch=('i686' 'x86_64')
url="http://www.mcs.anl.gov/petsc/petsc-as"
license=('?')
depends=('python2' 'gcc' 'mpich2' 'boost')
#conflicts=('umfpack')
source=(http://ftp.mcs.anl.gov/pub/petsc/release-snapshots/${pkgname}-${pkgver/_p5/}-p5.tar.gz)
md5sums=('b286063545a52b45f5f8960acf503ce2')

build() {
    local _build_dir=${srcdir}/${pkgname}-${pkgver/_/-}
    local _install_dir=/usr/petsc/${_config}
    cd ${_build_dir}
    unset PETSC_ARCH
    export PETSC_DIR=${_build_dir}
    #ldconfig -p | grep boost | grep ".so " | cut -d " " -f 4 | sort | uniq | grep -v mt\.so | xargs -IXX echo XX,
    python2 ./config/configure.py --prefix=${pkgdir}${_install_dir} \
	--with-mpi-dir=/opt/mpich2 \
	--with-mpi-shared=1 \
	--with-sieve \
	--download-umfpack=1 \
	--with-clanguage=cxx \
	--with-boost-include=/usr/include/boost \
	--with-boost-lib=[/usr/lib/libboost_date_time.so,/usr/lib/libboost_filesystem.so,/usr/lib/libboost_graph.so,/usr/lib/libboost_iostreams.so,/usr/lib/libboost_math_c99.so,/usr/lib/libboost_math_c99f.so,/usr/lib/libboost_math_c99l.so,/usr/lib/libboost_math_tr1.so,/usr/lib/libboost_math_tr1f.so,/usr/lib/libboost_math_tr1l.so,/usr/lib/libboost_prg_exec_monitor.so,/usr/lib/libboost_program_options.so,/usr/lib/libboost_python.so,/usr/lib/libboost_random.so,/usr/lib/libboost_regex.so,/usr/lib/libboost_serialization.so,/usr/lib/libboost_signals.so,/usr/lib/libboost_system.so,/usr/lib/libboost_unit_test_framework.so,/usr/lib/libboost_wave.so,/usr/lib/libboost_wserialization.so] \
	--with-umfpack=1 --with-umfpack-dir=/usr/lib \
	--with-shared=1 || return 1
    make || return 1
#--with-clanguage=cxx \
    sed -i s'/.\/config\/install.py/python2 .\/config\/install.py/' makefile

    make PETSC_DIR=${_build_dir} PETSC_ARCH=${_config} install || return 1

    grep ${srcdir} "${pkgdir}${_install_dir}/conf/petscvariables"
    grep ${pkgdir} "${pkgdir}${_install_dir}/conf/petscvariables"

    sed -i 's#'"${pkgdir}"'##g' "${pkgdir}${_install_dir}/conf/variables"
    sed -i 's#'"${pkgdir}"'##g' "${pkgdir}${_install_dir}/conf/petscvariables"
    sed -i 's#'"${srcdir}"'##g' "${pkgdir}${_install_dir}/conf/petscvariables"

    echo ${_install_dir} > /tmp/petsc.conf

    export PETSC_DIR=${_install_dir}
}
